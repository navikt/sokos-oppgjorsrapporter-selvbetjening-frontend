---
import { oppgjorsrapporterApiUrl } from '@src/utils/server/urls';
import type { Language } from '@src/language/language';
import type { RapportDTO } from '@src/schemas/types.ts';
import RapportKort from '../RapportKort.tsx';
import { ErrorSummary } from '@navikt/ds-react/ErrorSummary';
import logger from '@utils/logger.ts';

const { id } = Astro.props;

let rapportMetaData: RapportDTO | null = null;
let error: string | null = null;

if (!id) {
  error = 'Mangler rapport id i URL';
} else {
  const url = `${oppgjorsrapporterApiUrl}/${encodeURIComponent(id)}`;

  try {
    const response = await fetch(url);

    if (!response.ok) {
      error = `Klarte ikke Ã¥ hente rapportmetadata for id=${id}`;
      logger.error({
        msg: 'Failed to fetch rapport metadata',
        id,
        status: response.status,
        statusText: response.statusText,
        url,
      });
    } else {
      rapportMetaData = await response.json();
    }
  } catch (e) {
    error = 'Det oppstod en teknisk feil ved henting av rapportmetadata.';
    logger.error({
      msg: 'Exception when fetching rapport metadata',
      id,
      url,
      error: e instanceof Error ? { message: e.message, stack: e.stack } : e,
    });
  }
}

const language = Astro.currentLocale as Language;
---

{error && <ErrorSummary heading="Det oppstod en feil">{error}</ErrorSummary>}

{
  !error && rapportMetaData && (
    <RapportKort
      rapportMetaData={rapportMetaData}
      language={language}
      client:load
    />
  )
}
